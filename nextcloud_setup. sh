#!/usr/bin/env bash
set -euo pipefail

# Export PROMPT_START to avoid unbound variable errors.
export PROMPT_START=""

########################################
# ANSI Colors for Output
########################################
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
RED=$(tput setaf 1)
RESET=$(tput sgr0)

########################################
# Log Output
########################################
exec > >(tee /tmp/nextcloud_setup_summary.txt) 2>&1
clear

# Detect server IP (first IP from hostname -I)
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "${GREEN}Detected Server IP: ${SERVER_IP}${RESET}"
echo

echo "${GREEN}Starting Nextcloud Setup...${RESET}"
echo

########################################
# Restore Nextcloud Backup if Available
########################################
# Assumes Nextcloud web data should reside in ./nextcloud/html
if [ ! -d "./nextcloud/html" ]; then
    echo "${YELLOW}No Nextcloud data directory found. Checking for backups...${RESET}"
    found_backup=false
    for b in backup_[0-9][0-9][0-9][0-9][0-9][0-9]; do
        if [ -d "$b" ]; then
            echo "${YELLOW}Restoring backup directory '$b' to ./nextcloud/html...${RESET}"
            mv "$b" "./nextcloud/html"
            found_backup=true
            break
        fi
    done
    if [ "$found_backup" = false ]; then
        echo "${YELLOW}No backup found. Proceeding with a fresh installation.${RESET}"
    fi
fi
echo

########################################
# Nextcloud Deployment via Docker Compose
########################################
if ! docker ps -a --filter=name=nextcloud_server | grep -q nextcloud_server; then
    echo "${YELLOW}Deploying Nextcloud using Docker Compose...${RESET}"
    mkdir -p ~/nextcloud && cd ~/nextcloud || exit 1

    # Create docker-compose.yml for Nextcloud with a MariaDB backend.
    cat > docker-compose.yml <<'EOF'
version: '3.7'

services:
  nextcloud:
    container_name: nextcloud_server
    image: nextcloud:latest
    restart: always
    ports:
      - 8080:80
    volumes:
      - nextcloud_data:/var/www/html
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_password
    depends_on:
      - db

  db:
    container_name: nextcloud_db
    image: mariadb:latest
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: nextcloud_root_password
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloud_password
    volumes:
      - nextcloud_db:/var/lib/mysql

volumes:
  nextcloud_data:
  nextcloud_db:
EOF

    echo "${YELLOW}Starting Nextcloud container...${RESET}"
    docker compose up -d || { echo "${RED}docker compose up failed. Exiting.${RESET}"; exit 1; }
    echo "${GREEN}Nextcloud deployed successfully.${RESET}"
else
    echo "${GREEN}Nextcloud container already exists; skipping deployment.${RESET}"
fi
echo

########################################
# Simple Health Check for Nextcloud Container
########################################
echo "${YELLOW}Waiting for Nextcloud container to start...${RESET}"
max_attempts=6
running=false
for i in $(seq 1 $max_attempts); do
    status=$(docker inspect --format="{{.State.Status}}" nextcloud_server 2>/dev/null || echo "unknown")
    if [ "$status" = "running" ]; then
        running=true
        break
    fi
    sleep 5
done

if [ "$running" = false ]; then
    echo "${RED}Warning: Nextcloud container did not start within 30 seconds.${RESET}"
else
    echo "${GREEN}Nextcloud container is running.${RESET}"
fi
echo

########################################
# Advanced Network Accessibility Check
########################################
echo "${YELLOW}Checking network accessibility on port 8080...${RESET}"
HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' --connect-timeout 5 http://localhost:8080)
if [ "$HTTP_CODE" -eq 200 ]; then
    echo "${GREEN}Nextcloud is accessible on port 8080.${RESET}"
else
    echo "${RED}Nextcloud did not return a 200 OK on port 8080 (HTTP code: $HTTP_CODE).${RESET}"
    if systemctl is-active --quiet firewalld; then
        echo "${YELLOW}Firewalld is active. Attempting to open port 8080...${RESET}"
        sudo firewall-cmd --zone=public --add-port=8080/tcp --permanent
        sudo firewall-cmd --reload
        sleep 5
        HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' --connect-timeout 5 http://localhost:8080)
        if [ "$HTTP_CODE" -eq 200 ]; then
            echo "${GREEN}Port 8080 is now accessible after updating firewall rules.${RESET}"
        else
            echo "${RED}Port 8080 is still not accessible (HTTP code: $HTTP_CODE). Please check your network configuration manually.${RESET}"
        fi
    else
        echo "${YELLOW}Firewalld is not active. If you are using another firewall, ensure port 8080 is open.${RESET}"
    fi
fi
echo

########################################
# Automate Updating Trusted Domains Using occ
########################################
echo "${YELLOW}Updating Nextcloud trusted domains configuration using occ...${RESET}"
# Use the occ command to update trusted_domains safely.
docker exec -u www-data nextcloud_server php occ config:system:set trusted_domains 1 --value="${SERVER_IP}"
echo "${GREEN}Trusted domains updated.${RESET}"
echo "${GREEN}Restarting Nextcloud container to apply configuration changes...${RESET}"
docker restart nextcloud_server
echo

########################################
# Final Status Report with Dynamic QR Code
########################################
echo "${GREEN}=== Nextcloud Setup Complete ===${RESET}"
echo "Nextcloud is deployed and running on port 8080."
echo "Access it via http://${SERVER_IP}:8080"
echo

echo "${GREEN}Generating QR code for Nextcloud URL...${RESET}"
# Determine terminal width and calculate scale for the QR code.
TERM_COLS=$(tput cols)
# For a version 1 QR code, assume a base width of 21 modules.
# We'll use: scale = floor((TERM_COLS - 2) / 21)
scale=$(( (TERM_COLS - 2) / 21 ))
if [ "$scale" -lt 1 ]; then
    scale=1
fi
if [ "$scale" -gt 10 ]; then
    scale=10
fi

echo "${GREEN}Using scale factor: $scale${RESET}"
qrencode -t ANSIUTF8 -l H -s "$scale" "http://${SERVER_IP}:8080"
